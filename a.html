<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ã‚ ì“°ê¸° ì—°ìŠµ v8</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html {
  /* Geniallyê°€ iframeì„ scale()ë¡œ ì¤„ì—¬ë„
     100vw/100vhëŠ” í•­ìƒ iframe ë‚´ë¶€ ë·°í¬íŠ¸ ê¸°ì¤€ */
  width: 100%; height: 100%;
}
body {
  width: 100vw; height: 100vh;
  overflow: hidden;
  background: transparent;
  font-family: 'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
  user-select: none; -webkit-user-select: none;
  /* 1200x675 ê¸°ì¤€ ë¹„ìœ¨ = 16:9 */
  /* ëª¨ë“  px ê°’ì€ vw ë‹¨ìœ„ë¡œ ë³€í™˜: px/1200*100vw */
}

/*
  Genially ìŠ¬ë¼ì´ë“œ 1200Ã—675 ê¸°ì¤€ ë¹„ìœ¨ ë³€í™˜:
  px â†’ vw: value / 1200 * 100
  px â†’ vh: value / 675 * 100

  ì¸¡ì •ê°’ (Genially px):
    ê²©ì left:  629px  â†’ 52.42vw
    ê²©ì top:   191px  â†’ 28.30vh
    ê²©ì width: 533px  â†’ 44.42vw
    ê²©ì height:426px  â†’ 63.11vh
    ì…€ W: 106.6px â†’ 8.883vw
    ì…€ H: 106.6px â†’ 15.79vh
    topbar top: 157px  â†’ 23.26vh
*/

/* â”€â”€ ì „ì²´ ë˜í¼: pointer-events:noneìœ¼ë¡œ ë°°ê²½ í†µê³¼ â”€â”€ */
#app {
  position: fixed;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: transparent;
  pointer-events: none;
}

/* â”€â”€ ìƒë‹¨ ë°” â”€â”€ */
#topbar {
  position: absolute;
  left:  52.42vw;
  top:   23.26vh;
  width: 44.42vw;
  height: 4.00vh;
  display: flex;
  align-items: center;
  gap: 0.58vw;
  pointer-events: none;
}
.dot {
  width: 2.50vw; height: 2.50vw;
  max-width: 30px; max-height: 30px;
  min-width: 22px; min-height: 22px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.10vw; font-weight: 900; color: #fff;
  opacity: .25;
  transition: opacity .3s, transform .3s;
  box-shadow: 0 2px 6px rgba(0,0,0,.22);
  flex-shrink: 0;
}
.dot.on   { opacity:1; transform:scale(1.22); }
.dot.done { opacity:.85; }
#d1{background:#3B82F6;} #d2{background:#10B981;} #d3{background:#F59E0B;}
#spacer { flex:1; }
.tbtn {
  pointer-events: all;
  padding: 0.45vh 0.92vw;
  border: none; border-radius: 1.33vw;
  font-size: 0.92vw; font-weight: 800;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,.18);
  transition: opacity .15s, transform .15s;
  white-space: nowrap; flex-shrink: 0;
}
.tbtn:hover  { opacity:.82; transform:translateY(-1px); }
.tbtn:active { transform:translateY(0); }
#bUndo  { background:#8B5CF6; color:#fff; }
#bClear { background:#EF4444; color:#fff; }

/* â”€â”€ ê²©ì â”€â”€ */
#grid {
  position: absolute;
  left:   52.42vw;
  top:    28.30vh;
  width:  44.42vw;
  height: 63.11vh;
  pointer-events: none;
  /* 5ì—´ 4í–‰ */
  display: grid;
  grid-template-columns: repeat(5, 8.883vw);
  grid-template-rows:    repeat(4, 15.778vh);
}

/* â”€â”€ ê° ì…€ â”€â”€ */
.cell {
  position: relative;
  width:  8.883vw;
  height: 15.778vh;
  cursor: crosshair;
  background: transparent;
  touch-action: none;
  pointer-events: all;
  overflow: hidden;
}
.cell.active::before {
  content:''; position:absolute; inset:2px;
  border: 2px dashed rgba(59,130,246,.60);
  border-radius: 3px; pointer-events:none;
  animation: blink 1.1s linear infinite; z-index:5;
}
@keyframes blink { 50%{ border-color:rgba(59,130,246,1); } }
.badge {
  position:absolute; bottom:2px; right:4px;
  font-size:1.0vw; font-weight:900;
  pointer-events:none; z-index:10;
}
/* ìº”ë²„ìŠ¤: ì…€ì„ ê½‰ ì±„ì›€ */
.cell canvas {
  position:absolute; top:0; left:0;
  width:100%; height:100%;
  touch-action:none; display:block;
}

/* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
#toast {
  position: absolute;
  left:  74.63vw;
  top:   20.00vh;
  transform: translateX(-50%);
  padding: 0.6vh 1.5vw;
  border-radius: 1.2vw;
  font-size: 1.0vw; font-weight:800;
  white-space:nowrap; pointer-events:none;
  opacity:0; transition:opacity .2s; z-index:300;
  box-shadow:0 4px 16px rgba(0,0,0,.2);
}
#toast.show { opacity:1; }
.t-ok   { background:#10B981; color:#fff; }
.t-ng   { background:#EF4444; color:#fff; }
.t-info { background:rgba(255,255,255,.95); color:#333; border:1.5px solid #ddd; }

/* â”€â”€ ì •í™•ë„ ê²°ê³¼ íŒì—… â”€â”€ */
#score-popup {
  position: absolute;
  left: 74.63vw; top: 50vh;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 1.5vw;
  padding: 1.8vh 2.2vw;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  text-align: center;
  pointer-events: none;
  opacity: 0;
  transition: opacity .3s, transform .3s;
  z-index: 400;
  min-width: 14vw;
}
#score-popup.show {
  opacity: 1;
  pointer-events: all;
}
#score-ring {
  position: relative;
  width: 7vw; height: 7vw;
  margin: 0 auto 0.8vh;
}
#score-ring svg {
  width: 100%; height: 100%;
  transform: rotate(-90deg);
}
#score-ring .track { fill: none; stroke: #e8e8e8; stroke-width: 8; }
#score-ring .fill  { fill: none; stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dashoffset 1s ease; }
#score-num {
  position: absolute;
  inset: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8vw; font-weight: 900;
}
#score-label {
  font-size: 1.0vw; font-weight: 800; margin-bottom: 0.4vh;
}
#score-detail {
  display: none;
}
#score-close {
  padding: 0.4vh 1.2vw;
  background: #6366F1; color: white;
  border: none; border-radius: 2vw;
  font-size: 0.8vw; font-weight: 800;
  cursor: pointer;
}
#score-close:hover { opacity: 0.85; }
</style>
</head>
<body>
<div id="app">

  <div id="topbar">
    <div class="dot on" id="d1">1</div>
    <div class="dot"    id="d2">2</div>
    <div class="dot"    id="d3">3</div>
    <div id="spacer"></div>
    <button class="tbtn" id="bUndo">â†© ì´ì „ íš</button>
    <button class="tbtn" id="bClear">ğŸ—‘ ì „ì²´ ì§€ìš°ê¸°</button>
  </div>

  <div id="grid"></div>
  <div id="toast"></div>

  <!-- ì •í™•ë„ ê²°ê³¼ íŒì—… -->
  <div id="score-popup">
    <div id="score-ring">
      <svg viewBox="0 0 60 60">
        <circle class="track" cx="30" cy="30" r="24"/>
        <circle class="fill"  cx="30" cy="30" r="24"
          id="score-arc"
          stroke-dasharray="150.8"
          stroke-dashoffset="150.8"/>
      </svg>
      <div id="score-num">0%</div>
    </div>
    <div id="score-label">ã‚ ì •í™•ë„</div>
    <div id="score-detail"></div>
    <button id="score-close">í™•ì¸</button>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒìˆ˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COLS=5, ROWS=4, TOTAL=COLS*ROWS, MAX_S=3;
const COLORS=['#3B82F6','#10B981','#F59E0B'];
const LW_RATIO = 0.030; // íš êµµê¸° = ìº”ë²„ìŠ¤ ë„ˆë¹„ì˜ 3%
// ìº”ë²„ìŠ¤ í•´ìƒë„ëŠ” ì…€ CSS í”½ì…€ì˜ 2ë°°(ì„ ëª…ë„) â†’ ë™ì  ì„¤ì •
const CVS_SCALE = 2;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì…€ ìƒì„±
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const gridEl=document.getElementById('grid');
const cells=[];

for(let i=0;i<TOTAL;i++){
  const div=document.createElement('div');
  div.className='cell';

  const cvs=document.createElement('canvas');
  div.appendChild(cvs);
  gridEl.appendChild(div);

  const ctx=cvs.getContext('2d');
  ctx.lineCap='round'; ctx.lineJoin='round';
  cells.push({el:div,cvs,ctx,W:0,H:0,strokes:[],pts:[],drawing:false,done:false});
}

/* ìº”ë²„ìŠ¤ í•´ìƒë„ë¥¼ ì…€ ì‹¤ì œ CSS í”½ì…€ì— ë§ì¶° ì„¤ì • */
function initCanvasSizes(){
  cells.forEach(c=>{
    const r=c.el.getBoundingClientRect();
    const W=Math.round(r.width*CVS_SCALE);
    const H=Math.round(r.height*CVS_SCALE);
    if(W>0&&H>0){
      c.cvs.width=W; c.cvs.height=H;
      c.W=W; c.H=H;
      c.ctx.lineCap='round'; c.ctx.lineJoin='round';
    }
  });
}

/* DOMContentLoaded + ì•½ê°„ì˜ ì§€ì—° (iframe ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°) */
function tryInit(){
  initCanvasSizes();
  // ì²« ë²ˆì§¸ ì…€ í¬ê¸°ê°€ 0ì´ë©´ ì¬ì‹œë„
  if(cells[0].W===0){
    setTimeout(tryInit,100);
  } else {
    activate(0);
  }
}
document.addEventListener('DOMContentLoaded',()=>setTimeout(tryInit,50));
window.addEventListener('resize',()=>{
  initCanvasSizes();
  cells.forEach(c=>redraw(c));
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í™œì„± ì…€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let activeIdx=0;
function activate(idx){
  cells.forEach((c,i)=>c.el.classList.toggle('active',i===idx&&!c.done));
  activeIdx=idx;
  syncDots(cells[idx]?.strokes.length??0);
}

function syncDots(n){
  [1,2,3].forEach(i=>{
    const d=document.getElementById('d'+i);
    d.classList.remove('on','done');
    if(i<n+1)       d.classList.add('done');
    else if(i===n+1) d.classList.add('on');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë“œë¡œì‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function evPt(e,c){
  const r=c.cvs.getBoundingClientRect();
  const src=e.touches?e.touches[0]:e;
  return {
    x:(src.clientX-r.left)*(c.W/r.width),
    y:(src.clientY-r.top )*(c.H/r.height)
  };
}

function drawCurve(ctx,pts,color,W){
  if(pts.length<2)return;
  const lw=Math.max(2, W*LW_RATIO);
  ctx.save();
  ctx.strokeStyle=color; ctx.lineWidth=lw;
  ctx.beginPath();
  ctx.moveTo(pts[0].x,pts[0].y);
  for(let i=1;i<pts.length-1;i++){
    const mx=(pts[i].x+pts[i+1].x)/2, my=(pts[i].y+pts[i+1].y)/2;
    ctx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);
  }
  ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(pts[0].x,pts[0].y,lw*1.2,0,Math.PI*2);
  ctx.fillStyle=color; ctx.fill();
  ctx.restore();
}

function redraw(c){
  if(c.W===0)return;
  c.ctx.clearRect(0,0,c.W,c.H);
  c.strokes.forEach((s,i)=>drawCurve(c.ctx,s,COLORS[i],c.W));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ã‚ ë ˆí¼ëŸ°ìŠ¤ íš ê²½ë¡œ (Klee One ê¸°ì¤€, ì •ê·œí™” 0~1)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const REF_STROKES = [
  [[0.20,0.31],[0.28,0.29],[0.38,0.28],[0.50,0.28],[0.60,0.29],[0.68,0.31]],
  [[0.47,0.20],[0.45,0.30],[0.43,0.40],[0.38,0.52],[0.32,0.62],[0.26,0.72],[0.22,0.78]],
  [[0.56,0.32],[0.66,0.38],[0.72,0.50],[0.70,0.63],[0.60,0.73],[0.46,0.77],
   [0.32,0.72],[0.25,0.60],[0.26,0.47],[0.34,0.38],[0.46,0.34],[0.58,0.38],
   [0.66,0.48],[0.64,0.60]]
];

/* ì˜¤í”„ìŠ¤í¬ë¦° ìº”ë²„ìŠ¤ì— íš ê·¸ë¦¬ê¸° (ê³µí†µ) */
function drawPathToCanvas(oc, W, H, pts, isRef) {
  const ctx = oc.getContext('2d');
  const lw  = Math.max(4, W * 0.09); // ë‘ê»ê²Œ â†’ ê²¹ì¹¨ ê´€ëŒ€
  ctx.clearRect(0,0,W,H);
  ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.lineWidth=lw; ctx.strokeStyle='#000';
  ctx.beginPath();
  if(isRef){
    // ë ˆí¼ëŸ°ìŠ¤: ì •ê·œí™” ì¢Œí‘œ â†’ í”½ì…€
    const p0=[pts[0][0]*W, pts[0][1]*H];
    ctx.moveTo(p0[0],p0[1]);
    for(let i=1;i<pts.length-1;i++){
      const mx=(pts[i][0]+pts[i+1][0])/2*W;
      const my=(pts[i][1]+pts[i+1][1])/2*H;
      ctx.quadraticCurveTo(pts[i][0]*W,pts[i][1]*H,mx,my);
    }
    ctx.lineTo(pts[pts.length-1][0]*W, pts[pts.length-1][1]*H);
  } else {
    // í•™ìƒ: ì´ë¯¸ W/H í”½ì…€ ì¢Œí‘œ
    ctx.moveTo(pts[0].x,pts[0].y);
    for(let i=1;i<pts.length-1;i++){
      const mx=(pts[i].x+pts[i+1].x)/2;
      const my=(pts[i].y+pts[i+1].y)/2;
      ctx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);
    }
    ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
  }
  ctx.stroke();
  return ctx.getImageData(0,0,W,H).data; // í•œ ë²ˆë§Œ í˜¸ì¶œ!
}

function pixelIoU(dataA, dataB, total) {
  let inter=0, union=0;
  for(let i=3; i<total*4; i+=4){
    const a=dataA[i]>20?1:0, b=dataB[i]>20?1:0;
    if(a&&b) inter++;
    if(a||b) union++;
  }
  return union===0?0:inter/union;
}

function calcAccuracy(strokes, W, H) {
  if(strokes.length!==3) return null;
  const total = W*H;

  // 3íšì„ ëª¨ë‘ í•©ì³ì„œ ê¸€ì ì „ì²´ ëª¨ì–‘ ë¹„êµ
  // ë ˆí¼ëŸ°ìŠ¤: 3íš ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ìº”ë²„ìŠ¤ì—
  const ocR = document.createElement('canvas'); ocR.width=W; ocR.height=H;
  const ctxR = ocR.getContext('2d');
  const lwR = Math.max(4, W*0.09);
  ctxR.lineCap='round'; ctxR.lineJoin='round';
  ctxR.lineWidth=lwR; ctxR.strokeStyle='#000';

  REF_STROKES.forEach(refPts=>{
    ctxR.beginPath();
    ctxR.moveTo(refPts[0][0]*W, refPts[0][1]*H);
    for(let i=1;i<refPts.length-1;i++){
      const mx=(refPts[i][0]+refPts[i+1][0])/2*W;
      const my=(refPts[i][1]+refPts[i+1][1])/2*H;
      ctxR.quadraticCurveTo(refPts[i][0]*W,refPts[i][1]*H,mx,my);
    }
    ctxR.lineTo(refPts[refPts.length-1][0]*W,refPts[refPts.length-1][1]*H);
    ctxR.stroke();
  });
  const refData = ctxR.getImageData(0,0,W,H).data;

  // í•™ìƒ: 3íš ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ìº”ë²„ìŠ¤ì—
  const ocS = document.createElement('canvas'); ocS.width=W; ocS.height=H;
  const ctxS = ocS.getContext('2d');
  const lwS = Math.max(4, W*0.09);
  ctxS.lineCap='round'; ctxS.lineJoin='round';
  ctxS.lineWidth=lwS; ctxS.strokeStyle='#000';

  strokes.forEach(pts=>{
    ctxS.beginPath();
    ctxS.moveTo(pts[0].x,pts[0].y);
    for(let i=1;i<pts.length-1;i++){
      const mx=(pts[i].x+pts[i+1].x)/2;
      const my=(pts[i].y+pts[i+1].y)/2;
      ctxS.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);
    }
    ctxS.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
    ctxS.stroke();
  });
  const stuData = ctxS.getImageData(0,0,W,H).data;

  const iou = pixelIoU(refData, stuData, total);

  // IoU â†’ í¼ì„¼íŠ¸ ë³€í™˜
  // ì‹¤ì¸¡ ë³´ì •: ì˜ ì“´ í•„ê¸°ì˜ IoUëŠ” ë³´í†µ 0.25~0.45 ë²”ìœ„
  // IoU 0.20 â†’ 60ì , 0.35 â†’ 85ì , 0.45+ â†’ 100ì 
  const pct = Math.min(100, Math.max(0, Math.round((iou - 0.08) / 0.37 * 100)));

  return {
    pct,
    grade: pct>=85?'ì™„ë²½í•´ìš”! ğŸŒŸ':pct>=70?'ì˜ ì¼ì–´ìš”! ğŸ‘':pct>=50?'ì¡°ê¸ˆë§Œ ë”! ğŸ’ª':'ë‹¤ì‹œ ë„ì „! ğŸ”„'
  };
}

function showScorePopup(result) {
  const popup=document.getElementById('score-popup');
  const arc  =document.getElementById('score-arc');
  const num  =document.getElementById('score-num');
  const lbl  =document.getElementById('score-label');
  const det  =document.getElementById('score-detail');
  const C=150.8;
  const color=result.pct>=85?'#10B981':result.pct>=70?'#3B82F6':result.pct>=50?'#F59E0B':'#EF4444';
  arc.style.stroke=color;
  arc.style.strokeDashoffset=C;
  num.textContent=result.pct+'%'; num.style.color=color;
  lbl.textContent=result.grade;
  det.innerHTML=''; // íšë³„ ì ìˆ˜ ì—†ìŒ
  popup.classList.add('show');
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    arc.style.strokeDashoffset=C*(1-result.pct/100);
  }));
}
document.getElementById('score-close').addEventListener('click',()=>{
  document.getElementById('score-popup').classList.remove('show');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Klee One ã‚ íš íŒì •
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function judgeStroke(idx,pts,W,H){
  const xs=pts.map(p=>p.x), ys=pts.map(p=>p.y);
  const minX=Math.min(...xs), maxX=Math.max(...xs);
  const minY=Math.min(...ys), maxY=Math.max(...ys);
  const sX=pts[0].x/W, sY=pts[0].y/H;
  const eX=pts[pts.length-1].x/W;
  const spanX=(maxX-minX)/W, spanY=(maxY-minY)/H;

  /* 1íš: ìƒë‹¨ ê°€ë¡œíš */
  if(idx===0){
    if(sY>0.56)  return {ok:false,msg:'1íšì€ ë” ìœ„ìª½ì—ì„œ ì‹œì‘í•´ì•¼ í•´ìš”'};
    if(spanX<0.12) return {ok:false,msg:'1íšì€ ê°€ë¡œë¡œ ë” ê¸¸ê²Œ ê·¸ì–´ì•¼ í•´ìš”'};
    if(eX<sX-0.22) return {ok:false,msg:'1íšì€ ì˜¤ë¥¸ìª½ ë°©í–¥ìœ¼ë¡œ ê·¸ì–´ì•¼ í•´ìš”'};
    return {ok:true,msg:'1íš âœ“'};
  }
  /* 2íš: ì„¸ë¡œ/ì‚¬ì„  (ê´€ëŒ€) */
  if(idx===1){
    if(sX<0.03||sX>0.93) return {ok:false,msg:'2íšì„ ì…€ ì•ˆìª½ì—ì„œ ì‹œì‘í•´ ì£¼ì„¸ìš”'};
    if(sY<0.03||sY>0.80) return {ok:false,msg:'2íš ì‹œì‘ ìœ„ì¹˜ë¥¼ ì¡°ì •í•´ ì£¼ì„¸ìš”'};
    if(spanY<0.08)        return {ok:false,msg:'2íšì€ ì•„ë˜ ë°©í–¥ìœ¼ë¡œ ë‚´ë ¤ê·¸ì–´ì•¼ í•´ìš”'};
    return {ok:true,msg:'2íš âœ“'};
  }
  /* 3íš: í° ì›+ê¼¬ë¦¬ */
  if(idx===2){
    if(sX<0.05)           return {ok:false,msg:'3íšì€ ì˜¤ë¥¸ìª½ì—ì„œ ì‹œì‘í•´ì•¼ í•´ìš”'};
    if(sY>0.82)           return {ok:false,msg:'3íšì€ ë” ìœ„ìª½ì—ì„œ ì‹œì‘í•´ì•¼ í•´ìš”'};
    if(spanX+spanY<0.28)  return {ok:false,msg:'3íšì„ ë” í¬ê²Œ ê·¸ë ¤ì£¼ì„¸ìš”'};
    return {ok:true,msg:'3íš âœ“'};
  }
  return {ok:true,msg:''};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í† ìŠ¤íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tTimer;
function toast(msg,type='info',ms=1800){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className=`show t-${type}`;
  clearTimeout(tTimer);
  tTimer=setTimeout(()=>{el.className='';},ms);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì´ë²¤íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
cells.forEach((c,idx)=>{
  const {cvs}=c;

  cvs.addEventListener('pointerdown',e=>{
    e.preventDefault(); e.stopPropagation();
    if(c.W===0){initCanvasSizes();if(c.W===0)return;}
    cvs.setPointerCapture(e.pointerId);
    if(c.done){toast('ì´ë¯¸ ì™„ì„±í•œ ì¹¸ì´ì—ìš” âœ“','info');return;}
    activate(idx);
    if(c.strokes.length>=MAX_S){toast('3íš ì™„ë£Œ! â†© ë²„íŠ¼ìœ¼ë¡œ ë˜ëŒë¦¬ì„¸ìš”','info');return;}
    c.drawing=true; c.pts=[evPt(e,c)];
  },{passive:false});

  cvs.addEventListener('pointermove',e=>{
    e.preventDefault(); e.stopPropagation();
    if(!c.drawing)return;
    c.pts.push(evPt(e,c));
    redraw(c);
    drawCurve(c.ctx,c.pts,COLORS[c.strokes.length],c.W);
  },{passive:false});

  function onEnd(e){
    e.preventDefault(); e.stopPropagation();
    if(!c.drawing)return;
    c.drawing=false;
    if(c.pts.length<4){c.pts=[];return;}

    const sIdx=c.strokes.length;
    const result=judgeStroke(sIdx,c.pts,c.W,c.H);

    c.strokes.push([...c.pts]); c.pts=[];
    redraw(c); syncDots(c.strokes.length);

    // ë°°ì§€ ì—…ë°ì´íŠ¸
    c.el.querySelectorAll(`[data-s="${sIdx}"]`).forEach(b=>b.remove());
    const badge=document.createElement('div');
    badge.className='badge'; badge.dataset.s=sIdx;

    if(!result.ok){
      badge.textContent=`${sIdx+1}âœ—`; badge.style.color='#EF4444';
      c.el.appendChild(badge);
      toast(`âš ï¸ ${result.msg}`,'ng',3000);
    } else {
      badge.textContent=`${sIdx+1}âœ“`; badge.style.color=COLORS[sIdx]; badge.style.fontSize='0.9vw';
      c.el.appendChild(badge);
      if(c.strokes.length<MAX_S){
        toast(`${sIdx+1}íš ì™„ë£Œ âœ“  ë‹¤ìŒ: ${sIdx+2}íš`,'info',1000);
      } else {
        c.done=true; c.el.classList.remove('active');
        toast('ğŸ‰ ã‚ ì™„ì„±! ì •í™•ë„ ê³„ì‚° ì¤‘â€¦','ok',1500);
        // ì •í™•ë„ ê³„ì‚° (ì•½ê°„ ë”œë ˆì´ë¡œ toast ë¨¼ì € ë³´ì„)
        setTimeout(()=>{
          const acc = calcAccuracy(c.strokes, c.W, c.H);
          if(acc) showScorePopup(acc);
        }, 400);
        const nxt=cells.findIndex((cc,i)=>i>idx&&!cc.done);
        if(nxt!==-1) setTimeout(()=>activate(nxt),2800);
      }
    }
  }
  cvs.addEventListener('pointerup',    onEnd,{passive:false});
  cvs.addEventListener('pointercancel',onEnd,{passive:false});
});

document.getElementById('bUndo').addEventListener('click',e=>{
  e.stopPropagation();
  const c=cells[activeIdx];
  if(!c||c.strokes.length===0){toast('ì§€ìš¸ íšì´ ì—†ì–´ìš”','info');return;}
  const last=c.strokes.length-1;
  c.strokes.pop(); c.done=false;
  c.el.querySelectorAll(`[data-s="${last}"]`).forEach(b=>b.remove());
  c.el.classList.add('active');
  redraw(c); syncDots(c.strokes.length);
  toast(`â†© ${last+1}íš ì·¨ì†Œ`,'info',900);
});

document.getElementById('bClear').addEventListener('click',e=>{
  e.stopPropagation();
  cells.forEach(c=>{
    c.strokes=[]; c.pts=[]; c.drawing=false; c.done=false;
    c.el.querySelectorAll('.badge').forEach(b=>b.remove());
    c.el.classList.remove('active');
    if(c.W>0) c.ctx.clearRect(0,0,c.W,c.H);
  });
  activate(0);
  toast('ğŸ—‘ ì „ì²´ ì§€ì› ì–´ìš”!','info',1500);
});

syncDots(0);
</script>
</body>
</html>
